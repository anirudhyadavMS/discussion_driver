<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>User Sync Connectors Brainstorm</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#e2e8f0;
      --primary:#2563eb;
      --primary-weak:#dbeafe;
      --good:#16a34a;
      --warn:#f59e0b;
      --danger:#dc2626;
      --shadow: 0 10px 22px rgba(2,6,23,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(247,248,251,.9);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:18px 18px;}
    .topbar{display:flex; gap:14px; align-items:center; justify-content:space-between;}
    .title{display:flex; flex-direction:column; gap:2px;}
    h1{font-size:18px; margin:0; font-weight:700; letter-spacing:.2px;}
    .subtitle{font-size:12px; color:var(--muted)}

    .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:var(--card);
      padding:8px 10px;
      border-radius:999px;
      box-shadow: 0 2px 8px rgba(2,6,23,.04);
    }
    .chip label{font-size:12px; color:var(--muted)}
    .chip input[type="text"]{border:none; outline:none; font-size:12px; width:170px; color:var(--text);}

    button{
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      padding:9px 12px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(2,6,23,.04);
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
      font-weight:600;
      font-size:12px;
    }
    button:hover{border-color:#cbd5e1; box-shadow: 0 8px 20px rgba(2,6,23,.08)}
    button:active{transform: translateY(1px)}
    .primary{background:var(--primary); color:#fff; border-color:var(--primary)}
    .primary:hover{box-shadow: 0 10px 22px rgba(37,99,235,.25)}
    .ghost{background:transparent}

    main{max-width:1200px; margin:0 auto; padding:16px 18px 40px;}

    .grid{display:grid; grid-template-columns: 320px 1fr; gap:16px; align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
    }
    .card h2{font-size:13px; margin:0; font-weight:800; letter-spacing:.2px;}
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .bd{padding:14px;}

    .nav{display:flex; flex-direction:column; gap:8px;}
    .nav button{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border-radius:12px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .nav .meta{display:flex; flex-direction:column; gap:2px;}
    .nav .qtitle{font-size:12px; font-weight:800}
    .nav .qdesc{font-size:11px; color:var(--muted); line-height:1.2}

    .pill{
      font-size:10px; padding:4px 8px; border-radius:999px;
      background: #f1f5f9; color:#334155; border:1px solid var(--border);
      white-space:nowrap;
    }
    .active{
      border-color: var(--primary);
      box-shadow: 0 10px 24px rgba(37,99,235,.18);
      background: linear-gradient(0deg, rgba(37,99,235,.08), rgba(37,99,235,.08)), var(--card);
    }

    .two{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; align-items:start;}
    @media (max-width: 980px){ .two{grid-template-columns:1fr;} }

    textarea{
      width:100%;
      min-height:120px;
      resize:vertical;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.4;
      color:var(--text);
      outline:none;
      background:#fff;
    }
    textarea:focus{border-color:#93c5fd; box-shadow: 0 0 0 4px rgba(37,99,235,.12)}
    input[type="text"].lineInput{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      font-size:12px;
      outline:none;
      background:#fff;
    }
    input[type="text"].lineInput:focus{border-color:#93c5fd; box-shadow: 0 0 0 4px rgba(37,99,235,.12)}

    .hint{font-size:11px; color:var(--muted); line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    .kpi .box{border:1px solid var(--border); border-radius:12px; padding:10px; background: #fbfdff;}
    .kpi .label{font-size:10px; color:var(--muted)}
    .kpi .value{font-size:18px; font-weight:900; margin-top:4px}

    .list{display:flex; flex-direction:column; gap:10px;}

    .idea{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      background:#fff;
    }
    .idea .top{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .idea .txt{font-size:12px; line-height:1.35; white-space:pre-wrap; word-break:break-word;}
    .idea .by{font-size:10px; color:var(--muted); margin-top:6px}
    .vote{
      display:flex; flex-direction:column; align-items:center; gap:6px;
      border-left:1px dashed var(--border);
      padding-left:10px;
      min-width:62px;
    }
    .vote button{padding:6px 10px; border-radius:999px; font-weight:900}
    .vote .count{font-size:14px; font-weight:900}

    .voteRow{
      display:flex; gap:6px; align-items:center; justify-content:center;
    }
    .votePill{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      color:#334155;
      font-weight:800;
    }

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:10px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--border);
      background:#f8fafc;
      margin-right:6px;
      color:#334155;
    }

    .hr{height:1px; background:var(--border); margin:12px 0;}

    .timer{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background: #fff;
    }
    .timer .t{font-size:18px; font-weight:900; letter-spacing:.4px}
    .timer .small{font-size:10px; color:var(--muted)}

    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:#0f172a; color:#fff;
      padding:10px 12px; border-radius:999px;
      font-size:12px;
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      box-shadow: 0 18px 40px rgba(2,6,23,.35);
    }
    .toast.show{opacity:1}

    .modal{
      position:fixed; inset:0; background: rgba(15,23,42,.35);
      display:none; align-items:center; justify-content:center; padding:18px;
      z-index:50;
    }
    .modal.open{display:flex;}
    .modal .panel{
      width:min(920px, 96vw);
      max-height:80vh;
      overflow:auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: 0 30px 80px rgba(2,6,23,.45);
    }
    .panel .hd{position:sticky; top:0; background:rgba(255,255,255,.95); backdrop-filter: blur(10px);}
    pre{
      margin:0;
      padding:14px;
      background:#0b1220;
      color:#e5e7eb;
      overflow:auto;
      border-radius:12px;
      font-size:11px;
      line-height:1.4;
    }
    .smallbtn{padding:7px 10px; border-radius:10px;}

    /* Motivation ranking UI */
    .rankWrap{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
    }
    .rankHdr{display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .rankHdr .title{font-size:12px; font-weight:900; margin:0;}
    .rankHdr .sub{margin-top:4px; font-size:11px; color:var(--muted); line-height:1.35;}
    .rankList{display:flex; flex-direction:column; gap:10px;}
    .rankItem{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fbfdff;
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:start;
    }
    .rankItem.dragging{opacity:.7; border-color:#93c5fd; box-shadow: 0 10px 22px rgba(37,99,235,.18);}
    .rankNum{
      display:inline-flex; align-items:center; justify-content:center;
      width:24px; height:24px;
      border-radius:999px;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.25);
      font-weight:900;
      font-size:12px;
      margin-right:8px;
    }
    .rankRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .rankName{font-weight:900; font-size:12px;}
    .rankWhy{margin-top:8px;}
    .rankWhy textarea{min-height:74px;}
    .rankBtns{
      display:flex; flex-direction:column; gap:8px; align-items:stretch;
      border-left:1px dashed var(--border);
      padding-left:10px;
    }
    .rankBtns button{padding:6px 10px; border-radius:999px; font-weight:900;}
    .rankHint{font-size:10px; color:var(--muted); line-height:1.3; margin-top:8px;}
    .rankSummary{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;}

    /* Q2 flows */
    .linkTabs{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-bottom:10px;
    }
    .linkTabs a{
      font-size:12px;
      font-weight:900;
      color:var(--primary);
      text-decoration:none;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(37,99,235,.25);
      background: rgba(37,99,235,.06);
    }
    .linkTabs a:hover{background: rgba(37,99,235,.10)}
    .linkTabs a.activeTab{
      background: var(--primary);
      color:#fff;
      border-color: var(--primary);
    }

    /* Q3 pillars */
    .pillars{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-bottom:10px;
    }
    @media (max-width: 980px){
      .pillars{grid-template-columns:1fr;}
    }
    .pillarCard{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      cursor:pointer;
      transition: box-shadow .2s ease, transform .06s ease, border-color .2s ease;
    }
    .pillarCard:hover{border-color:#cbd5e1; box-shadow: 0 10px 22px rgba(2,6,23,.08)}
    .pillarCard:active{transform: translateY(1px)}
    .pillarCard.active{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 12px 26px rgba(37,99,235,.18);
      background: linear-gradient(0deg, rgba(37,99,235,.06), rgba(37,99,235,.06)), #fff;
    }
    .pillarTitle{font-size:12px; font-weight:1000; margin:0 0 6px;}
    .pillarSub{font-size:11px; color:var(--muted); margin:0; line-height:1.3;}
    .pillarDetail{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:12px;
      margin-bottom:12px;
    }
    .scenario{
      font-size:12px;
      line-height:1.4;
      color:#0f172a;
      margin-top:8px;
      white-space:pre-wrap;
    }
    .imgPlaceholder{
      margin-top:10px;
      border:1px dashed #cbd5e1;
      border-radius:14px;
      height:160px;
      background: linear-gradient(45deg, rgba(148,163,184,.12), rgba(148,163,184,.05));
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>User Sync Connectors ‚Äî Brainstorm Driver</h1>
        <div class="subtitle">Interactive facilitation board for a discussion on Copilot user sync connectors</div>
      </div>
      <div class="controls">
        <div class="chip">
          <label for="sessionName">Session</label>
          <input id="sessionName" type="text" placeholder="e.g., Jan 2026 brainstorm" />
        </div>
        <div class="chip">
          <label for="participant">Your name</label>
          <input id="participant" type="text" placeholder="e.g., Anirudh" />
        </div>
        <button class="ghost" id="resetBtn" title="Clear this device's saved state">Reset</button>
        <button id="exportBtn" class="primary">Export</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- Left: agenda -->
    <section class="card">
      <div class="hd">
        <h2>Agenda</h2>
        <span class="pill" id="progressPill">0 / 0</span>
      </div>
      <div class="bd">
        <div class="timer">
          <div>
            <div class="small">Section timer</div>
            <div class="t" id="timerText">10:00</div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="smallbtn" id="timerStart">Start</button>
            <button class="smallbtn" id="timerPause">Pause</button>
            <button class="smallbtn" id="timerReset">Reset</button>
          </div>
        </div>
        <div class="hint" style="margin-top:10px">
          Tip: Run each question as a mini-workshop: <b>1 min</b> silent writing ‚Üí <b>6 min</b> share/cluster ‚Üí <b>3 min</b> vote/decide.
        </div>
        <div class="hr"></div>
        <div class="nav" id="nav"></div>
      </div>
    </section>

    <!-- Right: active question -->
    <section class="card">
      <div class="hd">
        <div>
          <h2 id="qHeader">Question</h2>
          <div class="subtitle" id="qSub">Select a question on the left.</div>
        </div>
        <div class="row">
          <span class="pill" id="qPill">‚Äî</span>
          <button id="markDoneBtn" title="Toggle complete">Mark done</button>
        </div>
      </div>

      <div class="bd">
        <div class="two">
          <!-- Capture -->
          <div>

            <!-- Q1: Motivation panel -->
            <div id="motivationPanel" style="display:none; margin-bottom:12px;">
              <div class="rankWrap">
                <div class="rankHdr">
                  <div>
                    <div class="title">Critique & rank motivations</div>
                    <div class="sub">
                      Drag to reorder or use ‚ñ≤/‚ñº. Ask participants to challenge assumptions.
                      <br/><b>Rank 1</b> = highest priority.
                    </div>
                  </div>
                  <button class="ghost" id="resetMotivation">Reset ranks</button>
                </div>

                <div class="rankList" id="rankList"></div>
                <div class="rankSummary" id="rankSummary"></div>

                <div class="hr"></div>

                <div class="hint" style="margin-bottom:8px"><b>Capture critique ideas</b> (format: <b>Idea Proposer: &lt;idea&gt;</b>)</div>
                <div class="row" style="gap:8px; align-items:stretch">
                  <input id="q1IdeaInput" class="lineInput" type="text" placeholder="e.g., Priya: Parity matters only for top 3 enterprise connectors; otherwise focus on quality" />
                  <button id="q1AddIdea" class="primary">Add</button>
                </div>
                <div class="hint" style="margin-top:8px">Press <b>Enter</b> to add. These appear as idea cards on the right.</div>
              </div>
              <div class="hr"></div>
            </div>

            <!-- Q2: Flow tabs -->
            <div id="q2FlowPanel" style="display:none; margin-bottom:12px;">
              <div class="hint" style="margin-bottom:8px"><b>Choose a flow</b> and capture questions/feedback with likes & dislikes.</div>
              <div class="linkTabs">
                <a href="#" id="flowAdmin">Admin Flow</a>
                <a href="#" id="flowEndUser">End User Flow</a>
              </div>
              <div class="hint" style="margin-bottom:8px">Add a question/feedback item (optional format: <b>Proposer: &lt;question&gt;</b>)</div>
              <div class="row" style="gap:8px; align-items:stretch">
                <input id="q2FlowInput" class="lineInput" type="text" placeholder="e.g., Neha: Where does consent live if admin enabled but user connected?" />
                <button id="q2FlowAdd" class="primary">Add</button>
              </div>
              <div class="hint" style="margin-top:8px">Press <b>Enter</b> to add. Use üëç/üëé on cards to converge.</div>
              <div class="hr"></div>
            </div>

            <!-- Q3: Pillars -->
            <div id="q3PillarPanel" style="display:none; margin-bottom:12px;">
              <div class="hint" style="margin-bottom:10px"><b>3-pillar value framing</b> ‚Äî click a pillar to view scenarios and reserve space for an image.</div>
              <div class="pillars" id="pillars"></div>
              <div class="pillarDetail" id="pillarDetail" style="display:none;"></div>
              <div class="hr"></div>
            </div>

            
            <!-- Q4: Crawl / Walk / Run -->
            <div id="q4CwrPanel" style="display:none; margin-bottom:12px;">
              <div class="hint" style="margin-bottom:10px"><b>Crawl ‚Äì Walk ‚Äì Run</b> ‚Äî click a phase to view scope, non-goals, and success signals.</div>
              
            <!-- Q4a: Surfaces (Mainline/Researcher vs Agents) -->
            <div id="q4aSurfacesPanel" style="display:none; margin-bottom:12px;">
              <div class="hint" style="margin-bottom:10px"><b>Target surfaces</b> ‚Äî articulate the thesis per surface.</div>

              <div class="pillarDetail" style="margin-bottom:10px;">
                <div class="pillarTitle" style="margin:0 0 6px;">Mainline / Researcher</div>
                <div class="pillarSub">Virality via discovery</div>
                <div class="scenario">Drive growth with improved discovery via user-led distribution (remove Admin intervention)</div>
              </div>

              <div class="pillarDetail">
                <div class="pillarTitle" style="margin:0 0 6px;">Agents</div>
                <div class="pillarSub">Virality via sharing</div>
                <div class="scenario">Drive growth by enabling key people/team leads create Agents shared across the team respectively.</div>
              </div>

              <div class="hr"></div>
            </div>

<div class="pillars" id="cwrPhases"></div>
              <div class="pillarDetail" id="cwrDetail" style="display:none;"></div>
              <div class="hr"></div>
            </div>

<!-- Generic idea capture (hidden for Q1 and Q2; shown for Q3 and others) -->

            <!-- POV + LT feedback framing -->
            <div id="povPanel" class="pillarDetail" style="margin-bottom:12px;">
              <div class="pillarTitle" style="margin:0 0 6px;">Our POV</div>
              <div class="pillarSub" id="povSubtitle">What we believe and why</div>
              <div class="scenario" id="povBody"></div>
            </div>

            <div class="hint" style="margin-bottom:8px"><b>LT feedback</b> ‚Äî capture reactions, risks, and asks (one per card).</div>
            <div id="genericCapture">
              <textarea id="ideaInput" placeholder="Capture LT feedback (one per card). Keep it crisp and actionable."></textarea>
              <div class="row" style="justify-content:space-between; margin-top:10px">
                <div class="hint">Use <b>Shift+Enter</b> for a newline. Press <b>Enter</b> to add.</div>
                <div class="row">
                  <button id="addIdea" class="primary">Add</button>
                </div>
              </div>

              <div class="hr"></div>
              <div class="kpi">
                <div class="box">
                  <div class="label">Ideas (all)</div>
                  <div class="value" id="kIdeas">0</div>
                </div>
                <div class="box">
                  <div class="label">Top votes (this section)</div>
                  <div class="value" id="kTopVotes">0</div>
                </div>
                <div class="box">
                  <div class="label">Done</div>
                  <div class="value" id="kDone">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: idea cards -->
          <div id="ideaPane">
            <div class="row" style="justify-content:space-between; margin-bottom:8px">
              <div class="hint"><b>LT feedback cards</b></div>
              <div class="row">
                <button id="sortBtn" class="ghost" title="Toggle sort">Sort: Votes</button>
              </div>
            </div>
            <div class="list" id="ideaList"></div>
          </div>
        </div>
      </div>
    </section>

  </div>
</main>

<!-- Export modal -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="hd">
      <div class="wrap" style="padding:12px 14px">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2 style="margin:0">Export</h2>
            <div class="subtitle">Copy as JSON or Markdown</div>
          </div>
          <div class="row">
            <button class="smallbtn" id="copyJson">Copy JSON</button>
            <button class="smallbtn" id="copyMd">Copy Markdown</button>
            <button class="smallbtn" id="closeModal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="bd">
      <div class="hint" style="margin-bottom:10px">
        JSON is best for saving/importing; Markdown is best for sharing notes in docs.
      </div>
      <pre id="exportText"></pre>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copied</div>

<script>
(function(){
  const STORAGE_KEY = 'usc_brainstorm_v4';

  const MOTIVATIONS = [
    { id:'m1', name:'OpenAI parity', desc:'Match competitive expectations / feature completeness.' },
    { id:'m2', name:'AU w. enhanced discovery / virality', desc:'Drive active usage via better discovery, sharing, and distribution.' },
    { id:'m3', name:'Better response quality', desc:'Improve grounding, personalization, and relevance via synced user context.' }
  ];

  const PILLARS = [
    {
      id:'p1',
      title:'Personal AI Assistant for Work',
      subtitle:'Quick individual setup ‚Äì immediate payoff.',
      scenario:
        "A Slack power user connects Copilot to GDrive and Slack in just a few clicks‚Äîno IT help needed. By lunchtime, Copilot is synced and ready. She can instantly ask:\n\n‚ÄúSummarize latest of Project Atlas and update the Atlas Status sheet in GDrive.‚Äù\n\n‚ÄúFind the budget sheet I created and send the summary to Rohan.‚Äù"
    },
    {
      id:'p2',
      title:'Team Pilot, Bottom-Up Adoption',
      subtitle:'Small group uses user-sync to prove the case for AI.',
      scenario:
        "Finance team pilots AI with user-synced apps. They connect Google Drive and Slack to Copilot, enabling natural language queries like:\n\n‚ÄúWhat were last quarter‚Äôs key findings?‚Äù\n\n‚ÄúWhat issues came up during the audit?‚Äù\n\nPOC proves productivity gains without security risks. Their success becomes a proof point that convinces IT to roll out connectors org-wide‚Äîshowing how bottom-up adoption drives innovation."
    },
    {
      id:'p3',
      title:'Integrating Personal & Private Data',
      subtitle:'Bringing in data that admins can‚Äôt centrally index.',
      scenario:
        "User-level connectors enable Copilot to access data that admins can‚Äôt centrally index, such as an executive‚Äôs private calendar or 1:1 chats. With user authentication, assistants can securely connect calendars and email so Copilot can answer questions like:\n\n‚ÄúWhen is the next board meeting?‚Äù\n\n‚ÄúSummarize today‚Äôs CEO emails.‚Äù\n\nUnlike tenant connectors, this approach keeps data confidential and delivers personalized insights that broad integrations can‚Äôt provide."
    }
  ];


  const CWR_PHASES = [
    {
      id:'crawl',
      title:'Crawl',
      subtitle:'Prove value with a focused MVP.',
      scenario:
        "POV: Ship the smallest safe slice that proves user value.\n\nScope:\n- Deliver an MVP with limited, high-signal connectors\n- Mainline surfaces only (primary Copilot/chat experience)\n- Core flows: connect ‚Üí consent ‚Üí use ‚Üí revoke\n\nNon-goals:\n- Sharing agents/connections\n- Cross-user workflows\n- Tenant-wide enablement\n\nSuccess signals:\n- Meaningful usage lift in target cohort\n- Clear response-quality or time-saved proof points\n- Low support + low security incidents"
    },
    {
      id:'walk',
      title:'Walk',
      subtitle:'Expand coverage + enable richer experiences.',
      scenario:
        "POV: Turn the MVP into repeatable adoption by widening the funnel and unlocking compound use-cases.\n\nScope:\n- Expand to next top connectors\n- Enable Maker experiences (build/customize)\n- Enable Self-Agents (multi-step, multi-connector)\n- Better onboarding, error recovery, observability\n\nSuccess signals:\n- Multi-connector scenarios become common\n- Retention / weekly active usage increases\n- Admin sentiment improves (fewer exceptions, clearer controls)"
    },
    {
      id:'run',
      title:'Run',
      subtitle:'Scale, share, and institutionalize.',
      scenario:
        "POV: Move from individual value ‚Üí organizational leverage.\n\nScope:\n- Enable sharing of Agents & connections (clear permission model)\n- Build workflows that nudge admins toward tenant-sync for heavily used user-sync connectors\n- Converge user-sync + tenant-sync into a cohesive admin model\n\nSuccess signals:\n- Admin-led rollout / defaults\n- Ecosystem effects (shared agents)\n- Durable platform adoption (lower churn, higher stickiness)"
    }
  ];


  const QUESTIONS = [
    {
      id:'q1',
      title:'1. Motivation for user sync connectors',
      desc:'Critique the motivations and rank them by priority. Capture critique ideas as cards.',
      pov:'POV:\n- Motivation is **virality + growth**, not ‚Äúparity‚Äù.\n- User-sync should unlock **discovery + sharing loops** while staying user-led (minimal admin gating).\n\nLT feedback asks:\n- What is the #1 business metric we should anchor on?\n- Any red lines on security / privacy?',
      pill:'Why now',
      tags:[],
      starter:''
    },
    {
      id:'q2',
      title:'2. How is ChatGPT doing it?',
      desc:'Review two views (Admin Flow vs End User Flow). Add questions/feedback and vote with üëç/üëé.',
      pov:'POV:\n- Treat it as **admin policy + user connection**: admins enable the capability, users consent & connect accounts.\n- Default to **user-led distribution** (remove admin intervention where possible).\n\nLT feedback asks:\n- Where do we draw the line between user-led vs admin-led?\n- What approval points are non-negotiable?',
      pill:'Reference',
      tags:[],
      starter:''
    },
    {
      id:'q3',
      title:'3. Value framing for user sync connectors',
      desc:'Use a 3-pillar framing. Click into a pillar to review scenarios and reserve image space.',
      pov:'POV:\n- Frame value in 3 pillars:\n  1) Personal AI assistant for work\n  2) Team pilot ‚Üí bottom-up adoption\n  3) Integrating personal & private data\n\nLT feedback asks:\n- Which pillar should we lead with for MVP?',
      pill:'Narrative',
      tags:[
        'What is the buyer story vs user story?',
        'What metrics prove value?',
        'What is the strongest pillar for MVP?'
      ],
      starter:'Draft 1‚Äì2 sentences for the value prop and list measurable outcomes.'
    },
    {
      id:'q4',
      title:'4. MVP phasing: Crawl ‚Äì Walk ‚Äì Run',
      desc:'Crawl / Walk / Run ‚Äî agree the rollout phasing and what ‚Äúdone‚Äù means per phase.',
      pov:'POV (Crawl‚ÄìWalk‚ÄìRun):\n- **Crawl:** MVP on limited connectors + mainline surfaces to prove value safely.\n- **Walk:** Expand connectors + enable Maker + Self-Agents.\n- **Run:** Enable sharing of Agents & connections; workflows that push admins toward tenant-sync for heavily used user-sync connectors.\n\nLT feedback asks:\n- Are phases sequenced correctly?\n- What‚Äôs the minimum proof for moving Crawl ‚Üí Walk?',
      pill:'Phasing',
      tags:[
        'Crawl: MVP scope (limited connectors + mainline surfaces)',
        'Walk: Next connectors + Maker + Self-Agents',
        'Run: Share agents & connections + workflows ‚Üí tenant-sync',
        'Success metrics per phase'
      ],
      starter:
        'Crawl ‚Äì Deliver an MVP and prove value with limited connectors and surfaces (Mainline only)\n\nWalk ‚Äì Expand to next top connectors and enable Maker + Self-Agents experiences\n\nRun ‚Äì Enable sharing of Agents & connections. Build workflows to push Admins to enable tenant-sync for heavily used user-sync connectors.'
    },
    {
      id:'q4a',
      title:'4a. Which surfaces should we target?',
      desc:'Two target surfaces ‚Äî Mainline/Researcher and Agents ‚Äî each with a virality thesis.',
      pov:'POV (2 surfaces):\n- **Mainline/Researcher:** *Virality via discovery* ‚Äî drive growth with improved discovery via user-led distribution (remove Admin intervention).\n- **Agents:** *Virality via sharing* ‚Äî enable key people/team leads to create Agents shared across the team.\n\nLT feedback asks:\n- Which surface should lead in the narrative?\n- Any concerns about sharing model?',
      pill:'Surfaces',
      tags:[
        'Admin console',
        'End-user settings / profile',
        'In-product onboarding',
        'Copilot chat / composer'
      ],
      starter:
        'List candidate surfaces and what users do there.\n\nFor each surface: trigger ‚Üí action ‚Üí feedback ‚Üí recovery (errors/permissions).'
    },
    {
      id:'q4b',
      title:'4b. Which connectors are we targeting?',
      desc:'Prioritize connectors by impact and feasibility.',
      pov:'POV:\n- Start with **Tier-1 connectors** that maximize immediate daily value and virality loops (discovery/sharing).\n- Keep MVP narrow; expand only after strong signal.\n\nLT feedback asks:\n- Which 2‚Äì3 connectors must be in Crawl?',
      pill:'Targets',
      tags:[
        'Top 3 by customer demand',
        'Top 3 by technical feasibility',
        'Enterprise-critical sources',
        'Long-tail / future'
      ],
      starter:
        'Create a short list:\n- Tier 1 (MVP)\n- Tier 2 (next)\n- Tier 3 (later)\n\nAdd why: demand, coverage, complexity, risk.'
    },
    {
      id:'q4c',
      title:'4c. What is the data ingest model?',
      desc:'What data is synced, how, and with what guarantees?',
      pov:'POV:\n- Keep ingest minimal + safe: identity mapping + entitlements first; then deltas; strong audit/observability.\n- Prefer **delta / event-driven** where possible; define clear SLAs.\n\nLT feedback asks:\n- What latency / SLA is acceptable for MVP?',
      pill:'Data',
      tags:[
        'Identity + org mapping',
        'Groups / roles / entitlements',
        'Delta vs full sync',
        'Latency + SLAs'
      ],
      starter:
        'Define:\n- Entities (users, groups, roles‚Ä¶)\n- Mapping keys\n- Sync mode (full/delta/event-driven)\n- Storage + retention\n- Auditing + observability'
    },
    {
      id:'q4d',
      title:'4d. MVP phases',
      desc:'A phased plan to reduce risk and ship sooner.',
      pov:'POV:\n- Use phased rollout with entry/exit criteria: threat model ‚Üí limited beta ‚Üí GA for Tier-1 ‚Üí scale + ecosystem.\n- Distinguish hardening vs new features.\n\nLT feedback asks:\n- What is the right cohort for beta? Any must-have launch partners?',
      pill:'Phases',
      tags:[
        'Phase 0: Design + threat model',
        'Phase 1: Limited beta',
        'Phase 2: GA for Tier-1 connectors',
        'Phase 3: Scale + ecosystem'
      ],
      starter:
        'Draft phases with: entry criteria, exit criteria, and customer cohort.\n\nAlso call out what is ‚Äúhardening work‚Äù vs ‚Äúnew features‚Äù.'
    },
    {
      id:'q5',
      title:'5. Unifying connectors for Admin + end-user',
      desc:'One mental model and one system for many connector types.',
      pov:'POV:\n- One connector mental model: shared primitives (auth, scopes, policy), consistent lifecycle (install‚Üíconfigure‚Üímonitor), clear delegation (admin enables, user connects).\n\nLT feedback asks:\n- What do we need to make admins comfortable while keeping it user-led?',
      pill:'Unify',
      tags:[
        'Shared primitives (auth, scopes, policies)',
        'Connector lifecycle (install‚Üíconfigure‚Üímonitor)',
        'Delegation model (admin enables, user connects)',
        'Consistency across types'
      ],
      starter:
        'Propose a unified model:\n- Primitives (connector, account, policy, workspace, permission)\n- Admin actions vs user actions\n- Audit logs + health\n\nThen list edge cases (multi-tenant, offboarding, revocation).'
    }
  ];

  // ---------- State ----------
  const defaultState = {
    sessionName: '',
    participant: '',
    activeId: QUESTIONS[0].id,
    sortMode: 'votes', // votes | time
    timerSecondsDefault: 600,
    timerSecondsLeft: 600,
    timerRunning: false,
    done: Object.fromEntries(QUESTIONS.map(q => [q.id, false])),
    ideas: Object.fromEntries(QUESTIONS.map(q => [q.id, []])),
    motivationRank: MOTIVATIONS.map(m => m.id),
    motivationCritique: Object.fromEntries(MOTIVATIONS.map(m => [m.id, ''])),
    q1Ideas: [], // idea cards for Q1 (author + text + votes)
    q2ActiveFlow: 'admin', // admin | endUser
    q2Flows: { admin: [], endUser: [] }, // {id, author, text, likes, dislikes, createdAt}
    q3ActivePillar: 'p1',
    q4ActivePhase: 'crawl'
  };

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultState);
      const parsed = JSON.parse(raw);
      return {
        ...structuredClone(defaultState),
        ...parsed,
        done: { ...structuredClone(defaultState.done), ...(parsed.done||{}) },
        ideas: { ...structuredClone(defaultState.ideas), ...(parsed.ideas||{}) },
        motivationCritique: { ...structuredClone(defaultState.motivationCritique), ...(parsed.motivationCritique||{}) },
        motivationRank: Array.isArray(parsed.motivationRank) && parsed.motivationRank.length ? parsed.motivationRank : structuredClone(defaultState.motivationRank),
        q1Ideas: Array.isArray(parsed.q1Ideas) ? parsed.q1Ideas : [],
        q2Flows: parsed.q2Flows && typeof parsed.q2Flows === 'object'
          ? { admin: Array.isArray(parsed.q2Flows.admin) ? parsed.q2Flows.admin : [],
              endUser: Array.isArray(parsed.q2Flows.endUser) ? parsed.q2Flows.endUser : [] }
          : structuredClone(defaultState.q2Flows),
        q2ActiveFlow: (parsed.q2ActiveFlow === 'endUser') ? 'endUser' : 'admin',
        q3ActivePillar: parsed.q3ActivePillar || 'p1',
        q4ActivePhase: parsed.q4ActivePhase || 'crawl'
      };
    }catch(e){
      return structuredClone(defaultState);
    }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  let state = load();

  // ---------- DOM ----------
  const nav = document.getElementById('nav');
  const qHeader = document.getElementById('qHeader');
  const qSub = document.getElementById('qSub');
  const qPill = document.getElementById('qPill');

  const promptRow = document.getElementById('promptRow');
  const promptTags = document.getElementById('promptTags');
  const seedBtn = document.getElementById('seedBtn');

  const genericCapture = document.getElementById('genericCapture');
  const ideaInput = document.getElementById('ideaInput');
  const povPanel = document.getElementById('povPanel');
  const povSubtitle = document.getElementById('povSubtitle');
  const povBody = document.getElementById('povBody');
  const ideaList = document.getElementById('ideaList');
  const ideaPane = document.getElementById('ideaPane');

  const progressPill = document.getElementById('progressPill');
  const markDoneBtn = document.getElementById('markDoneBtn');
  const sortBtn = document.getElementById('sortBtn');

  const kIdeas = document.getElementById('kIdeas');
  const kTopVotes = document.getElementById('kTopVotes');
  const kDone = document.getElementById('kDone');

  const sessionName = document.getElementById('sessionName');
  const participant = document.getElementById('participant');

  const timerText = document.getElementById('timerText');
  const timerStart = document.getElementById('timerStart');
  const timerPause = document.getElementById('timerPause');
  const timerReset = document.getElementById('timerReset');

  const exportBtn = document.getElementById('exportBtn');
  const resetBtn = document.getElementById('resetBtn');

  const modal = document.getElementById('modal');
  const exportText = document.getElementById('exportText');
  const copyJson = document.getElementById('copyJson');
  const copyMd = document.getElementById('copyMd');
  const closeModal = document.getElementById('closeModal');

  const toast = document.getElementById('toast');

  // Q1 UI
  const motivationPanel = document.getElementById('motivationPanel');
  const rankList = document.getElementById('rankList');
  const rankSummary = document.getElementById('rankSummary');
  const resetMotivation = document.getElementById('resetMotivation');
  const q1IdeaInput = document.getElementById('q1IdeaInput');
  const q1AddIdea = document.getElementById('q1AddIdea');

  // Q2 UI
  const q2FlowPanel = document.getElementById('q2FlowPanel');
  const flowAdmin = document.getElementById('flowAdmin');
  const flowEndUser = document.getElementById('flowEndUser');
  const q2FlowInput = document.getElementById('q2FlowInput');
  const q2FlowAdd = document.getElementById('q2FlowAdd');

  // Q3 UI
  const q3PillarPanel = document.getElementById('q3PillarPanel');
  const pillars = document.getElementById('pillars');
  const pillarDetail = document.getElementById('pillarDetail');

  // Q4 UI (Crawl / Walk / Run)
  const q4CwrPanel = document.getElementById('q4CwrPanel');
  const cwrPhases = document.getElementById('cwrPhases');
  const cwrDetail = document.getElementById('cwrDetail');

  // Q4a UI (Surfaces thesis)
  const q4aSurfacesPanel = document.getElementById('q4aSurfacesPanel');
  // ---------- Utilities ----------
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function nowISO(){ return new Date().toISOString(); }
  function fmtTime(s){
    const m = Math.floor(s/60);
    const r = s%60;
    return String(m).padStart(2,'0') + ':' + String(r).padStart(2,'0');
  }
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1100);
  }
  function activeQ(){ return QUESTIONS.find(q => q.id === state.activeId) || QUESTIONS[0]; }
  function getMotivation(id){ return MOTIVATIONS.find(m => m.id === id); }
  function getPillar(id){ return PILLARS.find(p => p.id === id); }
  function getCwrPhase(id){ return CWR_PHASES.find(p => p.id === id); }

  function parseProposerIdea(line){
    const s = (line||'').trim();
    const idx = s.indexOf(':');
    if(idx === -1){
      const fallback = (state.participant||'').trim() || 'Anonymous';
      return { proposer: fallback, text: s };
    }
    const proposer = s.slice(0, idx).trim() || ((state.participant||'').trim() || 'Anonymous');
    const text = s.slice(idx+1).trim();
    return { proposer, text };
  }

  // ---------- Render: Left nav ----------
  function renderNav(){
    nav.innerHTML = '';
    QUESTIONS.forEach((q) => {
      const btn = document.createElement('button');
      const left = document.createElement('div');
      left.className = 'meta';
      const t = document.createElement('div');
      t.className = 'qtitle';
      t.textContent = q.title;
      // NOTE: keep agenda compact ‚Äî show title only (details render on right).
      left.appendChild(t);

      const right = document.createElement('div');
      right.className = 'pill';
      const done = state.done[q.id];

      const counts = {
        q1: (state.q1Ideas||[]).length,
        q2: ((state.q2Flows?.admin||[]).length + (state.q2Flows?.endUser||[]).length),
      };

      if(done){
        right.textContent = 'Done';
        right.style.background = 'rgba(22,163,74,.12)';
        right.style.borderColor = 'rgba(22,163,74,.35)';
        right.style.color = '#166534';
      } else if(q.id === 'q1'){
        right.textContent = counts.q1 ? `${counts.q1} ideas` : q.pill;
      } else if(q.id === 'q2'){
        right.textContent = counts.q2 ? `${counts.q2} items` : q.pill;
      } else {
        const ideaCount = (state.ideas[q.id]||[]).length;
        right.textContent = ideaCount ? `${ideaCount} ideas` : q.pill;
      }

      btn.appendChild(left);
      btn.appendChild(right);

      if(q.id === state.activeId) btn.classList.add('active');
      btn.addEventListener('click', () => {
        state.activeId = q.id;
        save();
        render();
      });

      nav.appendChild(btn);
    });

    const doneCount = Object.values(state.done).filter(Boolean).length;
    progressPill.textContent = `${doneCount} / ${QUESTIONS.length}`;
  }

  // ---------- Render: Header & tags ----------
  function renderHeader(){
    const q = activeQ();
    qHeader.textContent = q.title;
    qSub.textContent = q.desc;
    qPill.textContent = q.pill;

    markDoneBtn.textContent = state.done[q.id] ? 'Mark not done' : 'Mark done';
    markDoneBtn.style.borderColor = state.done[q.id] ? 'rgba(22,163,74,.45)' : 'var(--border)';

    promptTags.innerHTML = '';
    q.tags.forEach(tag => {
      const el = document.createElement('span');
      el.className = 'tag';
      el.textContent = tag;
      promptTags.appendChild(el);
    });
  }


  function renderPOV(){
    const q = activeQ();
    // POV is optional; hide panel if missing
    const pov = (q.pov || '').trim();
    povPanel.style.display = pov ? 'block' : 'none';
    if(!pov) return;

    // Simple formatting: 
 -> line breaks
    povSubtitle.textContent = 'What we believe and what we want feedback on';
    povBody.textContent = pov;
  }


  // ---------- Render: Q1 ranking ----------
  function renderQ1(){
    // Workshop UI disabled for LT review; use POV + LT feedback instead.
    motivationPanel.style.display = 'none';
    return;

    if(!isQ1) return;

    // ensure rank valid
    const set = new Set(state.motivationRank);
    MOTIVATIONS.forEach(m => { if(!set.has(m.id)) state.motivationRank.push(m.id); });
    state.motivationRank = state.motivationRank.filter(id => MOTIVATIONS.some(m => m.id === id));

    rankList.innerHTML = '';
    rankSummary.innerHTML = '';
    let dragId = null;

    state.motivationRank.forEach((mid, idx) => {
      const m = getMotivation(mid);

      const item = document.createElement('div');
      item.className = 'rankItem';
      item.draggable = true;

      item.addEventListener('dragstart', (e) => {
        dragId = mid;
        item.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      item.addEventListener('dragend', () => {
        dragId = null;
        item.classList.remove('dragging');
      });
      item.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
      item.addEventListener('drop', (e) => {
        e.preventDefault();
        if(!dragId || dragId === mid) return;
        const from = state.motivationRank.indexOf(dragId);
        const to = state.motivationRank.indexOf(mid);
        if(from < 0 || to < 0) return;
        state.motivationRank.splice(from, 1);
        state.motivationRank.splice(to, 0, dragId);
        save();
        renderQ1();
      });

      const left = document.createElement('div');
      const row = document.createElement('div');
      row.className = 'rankRow';

      const num = document.createElement('span');
      num.className = 'rankNum';
      num.textContent = String(idx + 1);

      const name = document.createElement('div');
      name.className = 'rankName';
      name.textContent = m.name;

      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.textContent = m.desc;

      row.appendChild(num);
      row.appendChild(name);
      row.appendChild(pill);

      const why = document.createElement('div');
      why.className = 'rankWhy';
      const ta = document.createElement('textarea');
      ta.placeholder = 'Critique notes (optional): evidence, risks, and trade-offs‚Ä¶';
      ta.value = state.motivationCritique[mid] || '';
      ta.addEventListener('input', () => {
        state.motivationCritique[mid] = ta.value;
        save();
      });
      why.appendChild(ta);

      left.appendChild(row);
      left.appendChild(why);

      const right = document.createElement('div');
      right.className = 'rankBtns';

      const up = document.createElement('button');
      up.textContent = '‚ñ≤';
      up.title = 'Move up';
      up.disabled = idx === 0;
      up.addEventListener('click', () => {
        if(idx === 0) return;
        const r = state.motivationRank;
        [r[idx-1], r[idx]] = [r[idx], r[idx-1]];
        save();
        renderQ1();
      });

      const down = document.createElement('button');
      down.textContent = '‚ñº';
      down.title = 'Move down';
      down.disabled = idx === state.motivationRank.length - 1;
      down.addEventListener('click', () => {
        const r = state.motivationRank;
        if(idx >= r.length - 1) return;
        [r[idx], r[idx+1]] = [r[idx+1], r[idx]];
        save();
        renderQ1();
      });

      right.appendChild(up);
      right.appendChild(down);

      item.appendChild(left);
      item.appendChild(right);
      rankList.appendChild(item);
    });

    state.motivationRank.forEach((mid, idx) => {
      const m = getMotivation(mid);
      const p = document.createElement('span');
      p.className = 'pill';
      p.style.background = 'rgba(37,99,235,.08)';
      p.style.borderColor = 'rgba(37,99,235,.20)';
      p.textContent = `#${idx+1} ${m.name}`;
      rankSummary.appendChild(p);
    });

    save();
  }


  // ---------- Render: Q4a Surfaces ----------
  function renderQ4a(){
    // Workshop UI optional; hide during LT review (POV captures the POV).
    q4aSurfacesPanel.style.display = 'none';
    return;
  }

  // ---------- Render: Q2 flows ----------
  function renderQ2(){
    // Workshop UI disabled for LT review; use POV + LT feedback instead.
    q2FlowPanel.style.display = 'none';
    return;

    if(!isQ2) return;

    function setTab(){
      flowAdmin.classList.toggle('activeTab', state.q2ActiveFlow === 'admin');
      flowEndUser.classList.toggle('activeTab', state.q2ActiveFlow === 'endUser');
    }
    setTab();

    flowAdmin.onclick = (e) => { e.preventDefault(); state.q2ActiveFlow = 'admin'; save(); render(); };
    flowEndUser.onclick = (e) => { e.preventDefault(); state.q2ActiveFlow = 'endUser'; save(); render(); };

    save();
  }

  // ---------- Render: Q3 pillars ----------
  function renderQ3(){
    // Workshop UI optional; hide during LT review (POV captures the narrative).
    q3PillarPanel.style.display = 'none';
    return;

    if(!isQ3) return;

    pillars.innerHTML = '';
    PILLARS.forEach(p => {
      const c = document.createElement('div');
      c.className = 'pillarCard' + (state.q3ActivePillar === p.id ? ' active' : '');
      c.addEventListener('click', () => {
        state.q3ActivePillar = p.id;
        save();
        renderQ3();
      });
      const t = document.createElement('div');
      t.className = 'pillarTitle';
      t.textContent = p.title;
      const s = document.createElement('div');
      s.className = 'pillarSub';
      s.textContent = p.subtitle;
      c.appendChild(t);
      c.appendChild(s);
      pillars.appendChild(c);
    });

    const cur = getPillar(state.q3ActivePillar);
    if(cur){
      pillarDetail.style.display = 'block';
      pillarDetail.innerHTML = `
        <div class="pillarTitle" style="margin:0 0 6px;">${cur.title}</div>
        <div class="pillarSub">${cur.subtitle}</div>
        <div class="scenario">${cur.scenario}</div>
        <div class="imgPlaceholder">Image placeholder (add later)</div>
      `;
    } else {
      pillarDetail.style.display = 'none';
      pillarDetail.innerHTML = '';
    }
  }


  // ---------- Render: Q4 Crawl/Walk/Run ----------
  function renderQ4(){
    // Workshop UI optional; hide during LT review (POV captures the POV).
    q4CwrPanel.style.display = 'none';
    return;
  }


  // ---------- Render: Idea cards (right pane) ----------
  function renderIdeaCards(){
    const q = activeQ();

    // Determine dataset by question
    if(q.id === 'q1'){
      renderStandardVotesList(state.q1Ideas || [], { mode: 'votes', allowDownvote: false, onDelete: deleteQ1Idea, onUp: upvoteQ1 });
      updateKpisFor(q.id);
      return;
    }
    if(q.id === 'q2'){
      const items = (state.q2Flows?.[state.q2ActiveFlow] || []);
      renderLikeDislikeList(items, { onDelete: deleteQ2Item, onLike: likeQ2, onDislike: dislikeQ2 });
      updateKpisFor(q.id);
      return;
    }

    // default: per-question ideas
    const items = [...(state.ideas[q.id]||[])];
    if(state.sortMode === 'votes'){
      items.sort((a,b) => (b.votes - a.votes) || (a.createdAt.localeCompare(b.createdAt)));
    } else {
      items.sort((a,b) => a.createdAt.localeCompare(b.createdAt));
    }
    renderStandardVotesList(items, {
      mode: state.sortMode,
      allowDownvote: false,
      onDelete: (id) => {
        state.ideas[q.id] = (state.ideas[q.id]||[]).filter(x => x.id !== id);
        save();
        render();
      },
      onUp: (id) => {
        const arr = state.ideas[q.id] || [];
        const idx = arr.findIndex(x => x.id === id);
        if(idx >= 0){
          arr[idx].votes += 1;
          save();
          render();
        }
      }
    });
    updateKpisFor(q.id);
  }

  function renderStandardVotesList(items, opts){
    // items: {id,text,author,votes,createdAt}
    let list = [...items];
    if(opts.mode === 'votes'){
      list.sort((a,b) => (b.votes - a.votes) || (a.createdAt.localeCompare(b.createdAt)));
    } else {
      list.sort((a,b) => a.createdAt.localeCompare(b.createdAt));
    }

    ideaList.innerHTML = '';
    if(list.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.style.padding = '10px 6px';
      empty.textContent = 'No items yet. Add the first one on the left.';
      ideaList.appendChild(empty);
      return;
    }

    list.forEach((it) => {
      const wrap = document.createElement('div');
      wrap.className = 'idea';

      const top = document.createElement('div');
      top.className = 'top';

      const left = document.createElement('div');
      left.style.flex = '1';

      const txt = document.createElement('div');
      txt.className = 'txt';
      txt.textContent = it.text;

      const by = document.createElement('div');
      by.className = 'by';
      const who = it.author || 'Anonymous';
      const when = new Date(it.createdAt).toLocaleString();
      by.textContent = `${who} ‚Ä¢ ${when}`;

      left.appendChild(txt);
      left.appendChild(by);

      const vote = document.createElement('div');
      vote.className = 'vote';

      const up = document.createElement('button');
      up.textContent = '‚ñ≤';
      up.title = 'Upvote';
      up.addEventListener('click', () => opts.onUp(it.id));

      const count = document.createElement('div');
      count.className = 'count';
      count.textContent = String(it.votes || 0);

      const del = document.createElement('button');
      del.textContent = '‚úï';
      del.title = 'Delete';
      del.addEventListener('click', () => opts.onDelete(it.id));

      vote.appendChild(up);
      vote.appendChild(count);
      vote.appendChild(del);

      top.appendChild(left);
      top.appendChild(vote);

      wrap.appendChild(top);
      ideaList.appendChild(wrap);
    });
  }

  function renderLikeDislikeList(items, opts){
    // items: {id,author,text,likes,dislikes,createdAt}
    const list = [...items].sort((a,b) => ((b.likes||0) - (a.likes||0)) || (a.createdAt.localeCompare(b.createdAt)));
    ideaList.innerHTML = '';

    if(list.length === 0){
      const empty = document.createElement('div');
      empty.className = 'hint';
      empty.style.padding = '10px 6px';
      empty.textContent = 'No items yet. Add the first one on the left.';
      ideaList.appendChild(empty);
      return;
    }

    list.forEach((it) => {
      const wrap = document.createElement('div');
      wrap.className = 'idea';

      const top = document.createElement('div');
      top.className = 'top';

      const left = document.createElement('div');
      left.style.flex = '1';

      const txt = document.createElement('div');
      txt.className = 'txt';
      txt.textContent = it.text;

      const by = document.createElement('div');
      by.className = 'by';
      const who = it.author || 'Anonymous';
      const when = new Date(it.createdAt).toLocaleString();
      by.textContent = `${who} ‚Ä¢ ${when}`;

      left.appendChild(txt);
      left.appendChild(by);

      const vote = document.createElement('div');
      vote.className = 'vote';

      const like = document.createElement('button');
      like.textContent = 'üëç';
      like.title = 'Like';
      like.addEventListener('click', () => opts.onLike(it.id));

      const dislike = document.createElement('button');
      dislike.textContent = 'üëé';
      dislike.title = 'Dislike';
      dislike.addEventListener('click', () => opts.onDislike(it.id));

      const row = document.createElement('div');
      row.className = 'voteRow';

      const lp = document.createElement('span');
      lp.className = 'votePill';
      lp.textContent = `üëç ${it.likes || 0}`;

      const dp = document.createElement('span');
      dp.className = 'votePill';
      dp.textContent = `üëé ${it.dislikes || 0}`;

      row.appendChild(lp);
      row.appendChild(dp);

      const del = document.createElement('button');
      del.textContent = '‚úï';
      del.title = 'Delete';
      del.addEventListener('click', () => opts.onDelete(it.id));

      vote.appendChild(like);
      vote.appendChild(dislike);
      vote.appendChild(row);
      vote.appendChild(del);

      top.appendChild(left);
      top.appendChild(vote);

      wrap.appendChild(top);
      ideaList.appendChild(wrap);
    });
  }

  function updateKpisFor(qid){
    const doneCount = Object.values(state.done).filter(Boolean).length;
    kDone.textContent = doneCount;

    const totalIdeas =
      Object.values(state.ideas).reduce((sum, arr) => sum + (arr?.length||0), 0) +
      (state.q1Ideas?.length||0) +
      ((state.q2Flows?.admin?.length||0) + (state.q2Flows?.endUser?.length||0));

    kIdeas.textContent = totalIdeas;

    let top = 0;
    if(qid === 'q1'){
      top = (state.q1Ideas||[]).reduce((m, it) => Math.max(m, it.votes||0), 0);
    } else if(qid === 'q2'){
      const items = (state.q2Flows?.[state.q2ActiveFlow] || []);
      top = items.reduce((m, it) => Math.max(m, it.likes||0), 0);
    } else {
      const items = (state.ideas[qid]||[]);
      top = items.reduce((m, it) => Math.max(m, it.votes||0), 0);
    }
    kTopVotes.textContent = top;
  }

  // ---------- Visibility per question ----------
  function applyVisibility(){
    const q = activeQ();
    const isQ1 = q.id === 'q1';
    const isQ2 = q.id === 'q2';
    const isQ3 = q.id === 'q3';
    const isQ4a = q.id === 'q4a';

    // Special panels
    renderQ1();
    renderQ2();
    renderQ3();
    renderQ4();
    renderQ4a();
    // Hide prompt helpers for Q1 + Q2 (they have their own capture); keep for others

    // Generic capture hidden for Q1 and Q2; shown for Q3 and others
    genericCapture.style.display = 'block';

    // Idea pane always visible (including Q1/Q2) per request
    ideaPane.style.display = 'block';

    // Sort button label
    if(isQ2){
      sortBtn.style.display = 'none';
    } else {
      sortBtn.style.display = 'inline-flex';
    }
  }

  // ---------- Actions ----------
  function addGenericIdea(){
    const q = activeQ();
    const text = (ideaInput.value || '').trim();
    if(!text) return;

    const idea = {
      id: uid(),
      text,
      votes: 0,
      createdAt: nowISO(),
      author: (state.participant || '').trim()
    };

    state.ideas[q.id] = state.ideas[q.id] || [];
    state.ideas[q.id].push(idea);
    ideaInput.value = '';
    save();
    render();
  }

  function addQ1Idea(){
    const raw = (q1IdeaInput.value || '').trim();
    if(!raw) return;
    const parsed = parseProposerIdea(raw);
    if(!parsed.text){
      showToast('Add text after ":"');
      return;
    }
    const item = {
      id: uid(),
      author: parsed.proposer,
      text: parsed.text,
      votes: 0,
      createdAt: nowISO()
    };
    state.q1Ideas = state.q1Ideas || [];
    state.q1Ideas.push(item);
    q1IdeaInput.value = '';
    save();
    render();
  }
  function upvoteQ1(id){
    const arr = state.q1Ideas || [];
    const idx = arr.findIndex(x => x.id === id);
    if(idx >= 0){
      arr[idx].votes += 1;
      save();
      render();
    }
  }
  function deleteQ1Idea(id){
    state.q1Ideas = (state.q1Ideas || []).filter(x => x.id !== id);
    save();
    render();
  }

  function addQ2FlowItem(){
    const raw = (q2FlowInput.value || '').trim();
    if(!raw) return;
    const parsed = parseProposerIdea(raw);
    if(!parsed.text){
      showToast('Add text after ":"');
      return;
    }
    const item = {
      id: uid(),
      author: parsed.proposer,
      text: parsed.text,
      likes: 0,
      dislikes: 0,
      createdAt: nowISO()
    };
    state.q2Flows[state.q2ActiveFlow] = state.q2Flows[state.q2ActiveFlow] || [];
    state.q2Flows[state.q2ActiveFlow].push(item);
    q2FlowInput.value = '';
    save();
    render();
  }
  function likeQ2(id){
    const arr = state.q2Flows[state.q2ActiveFlow] || [];
    const idx = arr.findIndex(x => x.id === id);
    if(idx >= 0){
      arr[idx].likes += 1;
      save();
      render();
    }
  }
  function dislikeQ2(id){
    const arr = state.q2Flows[state.q2ActiveFlow] || [];
    const idx = arr.findIndex(x => x.id === id);
    if(idx >= 0){
      arr[idx].dislikes += 1;
      save();
      render();
    }
  }
  function deleteQ2Item(id){
    state.q2Flows[state.q2ActiveFlow] = (state.q2Flows[state.q2ActiveFlow] || []).filter(x => x.id !== id);
    save();
    render();
  }

  // Generic: Shift+Enter = newline, Enter = submit
  ideaInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      addGenericIdea();
    }
  });

  // Q1: Enter = submit
  q1IdeaInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      addQ1Idea();
    }
  });

  // Q2: Enter = submit
  q2FlowInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      addQ2FlowItem();
    }
  });

  document.getElementById('addIdea').addEventListener('click', addGenericIdea);
  q1AddIdea.addEventListener('click', addQ1Idea);
  q2FlowAdd.addEventListener('click', addQ2FlowItem);

  markDoneBtn.addEventListener('click', () => {
    const q = activeQ();
    state.done[q.id] = !state.done[q.id];
    save();
    render();
  });

  sortBtn.addEventListener('click', () => {
    state.sortMode = state.sortMode === 'votes' ? 'time' : 'votes';
    save();
    render();
  });

  if(seedBtn){
  seedBtn.addEventListener('click', () => {
    const q = activeQ();
    if(!q.starter) return;
    if(ideaInput.value.trim().length){
      ideaInput.value = ideaInput.value + "

" + q.starter;
    } else {
      ideaInput.value = q.starter;
    }
    ideaInput.focus();
  });
}

  resetMotivation.addEventListener('click', () => {
    state.motivationRank = MOTIVATIONS.map(m => m.id);
    state.motivationCritique = Object.fromEntries(MOTIVATIONS.map(m => [m.id, '']));
    state.q1Ideas = [];
    save();
    render();
    showToast('Q1 reset');
  });

  sessionName.addEventListener('input', () => { state.sessionName = sessionName.value; save(); });
  participant.addEventListener('input', () => { state.participant = participant.value; save(); });

  // ---------- Timer ----------
  let tick = null;
  function stopTick(){ if(tick) clearInterval(tick); tick = null; }
  function startTick(){
    stopTick();
    tick = setInterval(() => {
      if(!state.timerRunning) return;
      if(state.timerSecondsLeft <= 0){
        state.timerRunning = false;
        stopTick();
        save();
        renderTimer();
        showToast('Time!');
        return;
      }
      state.timerSecondsLeft -= 1;
      save();
      renderTimer();
    }, 1000);
  }

  function renderTimer(){
    timerText.textContent = fmtTime(state.timerSecondsLeft);
    timerStart.textContent = state.timerRunning ? 'Running‚Ä¶' : 'Start';
    timerStart.disabled = state.timerRunning;
  }

  timerStart.addEventListener('click', () => {
    state.timerRunning = true;
    save();
    renderTimer();
    startTick();
  });
  timerPause.addEventListener('click', () => {
    state.timerRunning = false;
    save();
    renderTimer();
  });
  timerReset.addEventListener('click', () => {
    state.timerRunning = false;
    state.timerSecondsLeft = state.timerSecondsDefault;
    save();
    renderTimer();
  });

  // ---------- Export ----------
  function buildExportObject(){
    const payload = {
      version: 'v4',
      exportedAt: nowISO(),
      sessionName: state.sessionName || '',
      participant: state.participant || '',
      done: state.done,
      q1: {
        motivationRank: state.motivationRank.map((id, idx) => ({
          rank: idx + 1,
          id,
          name: getMotivation(id)?.name || id,
          critiqueNotes: state.motivationCritique[id] || ''
        })),
        ideas: (state.q1Ideas || []).slice().sort((a,b) => (b.votes-a.votes) || a.createdAt.localeCompare(b.createdAt))
      },
      q2: {
        flows: {
          admin: (state.q2Flows?.admin || []).slice().sort((a,b) => (b.likes-a.likes) || a.createdAt.localeCompare(b.createdAt)),
          endUser: (state.q2Flows?.endUser || []).slice().sort((a,b) => (b.likes-a.likes) || a.createdAt.localeCompare(b.createdAt))
        }
      },
      q3: {
        pillars: PILLARS,
        activePillar: state.q3ActivePillar
      },
      questions: QUESTIONS.filter(q => !['q1','q2'].includes(q.id)).map(q => ({
        id: q.id,
        title: q.title,
        desc: q.desc,
        ideas: (state.ideas[q.id]||[])
          .slice()
          .sort((a,b) => (b.votes - a.votes) || a.createdAt.localeCompare(b.createdAt))
      }))
    };
    return payload;
  }

  function toMarkdown(payload){
    const lines = [];
    const title = payload.sessionName ? `# ${payload.sessionName}` : '# User Sync Connectors ‚Äî Brainstorm Notes';
    lines.push(title);
    lines.push('');
    lines.push(`_Exported: ${new Date(payload.exportedAt).toLocaleString()}_`);
    if(payload.participant) lines.push(`_Local author name: ${payload.participant}_`);
    lines.push('');

    // Q1
    lines.push('## 1. Motivation for user sync connectors');
    lines.push('');
    lines.push('### Ranking');
    payload.q1.motivationRank.forEach(r => {
      lines.push(`- **#${r.rank} ‚Äî ${r.name}**`);
      if(r.critiqueNotes && r.critiqueNotes.trim()){
        lines.push(`  - Notes: ${r.critiqueNotes.replace(/\n/g,'  \n    ')}`);
      }
    });
    lines.push('');
    lines.push('### Critique ideas');
    if(!payload.q1.ideas.length){
      lines.push('_No ideas captured._');
    } else {
      payload.q1.ideas.forEach(it => lines.push(`- **(${it.votes} votes)** **${it.author || 'Anonymous'}:** ${it.text.replace(/\n/g,'  \n  ')}`));
    }
    lines.push('');

    // Q2
    lines.push('## 2. How is ChatGPT doing it?');
    lines.push('');
    ['admin','endUser'].forEach(flow => {
      lines.push(`### ${flow === 'admin' ? 'Admin Flow' : 'End User Flow'}`);
      const items = payload.q2.flows[flow] || [];
      if(!items.length){
        lines.push('_No items captured._');
      } else {
        items.forEach(it => lines.push(`- **üëç ${it.likes} / üëé ${it.dislikes}** **${it.author || 'Anonymous'}:** ${it.text.replace(/\n/g,'  \n  ')}`));
      }
      lines.push('');
    });

    // Q3 pillars
    lines.push('## 3. Value framing for user sync connectors');
    lines.push('');
    lines.push('### 3-pillar framing');
    payload.q3.pillars.forEach(p => {
      lines.push(`- **${p.title}** ‚Äî ${p.subtitle}`);
    });
    lines.push('');

    // Remaining questions
    payload.questions.forEach(q => {
      const isDone = !!payload.done[q.id];
      lines.push(`## ${q.title}${isDone ? ' ‚úÖ' : ''}`);
      lines.push('');
      lines.push(q.desc);
      lines.push('');
      if(!q.ideas.length){
        lines.push('_No ideas captured._');
        lines.push('');
        return;
      }
      q.ideas.forEach(it => {
        const who = it.author || 'Anonymous';
        const when = new Date(it.createdAt).toLocaleString();
        lines.push(`- **(${it.votes} votes)** ${it.text.replace(/\n/g,'  \n  ')}  `);
        lines.push(`  _${who} ‚Ä¢ ${when}_`);
      });
      lines.push('');
    });

    return lines.join('\n');
  }

  function openExport(){
    const payload = buildExportObject();
    exportText.textContent = JSON.stringify(payload, null, 2);
    modal.classList.add('open');
  }

  exportBtn.addEventListener('click', openExport);
  closeModal.addEventListener('click', () => modal.classList.remove('open'));
  modal.addEventListener('click', (e) => { if(e.target === modal) modal.classList.remove('open'); });

  async function copyToClipboard(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast('Copied');
    } catch {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      showToast('Copied');
    }
  }

  copyJson.addEventListener('click', () => copyToClipboard(JSON.stringify(buildExportObject(), null, 2)));
  copyMd.addEventListener('click', () => copyToClipboard(toMarkdown(buildExportObject())));

  // ---------- Reset ----------
  resetBtn.addEventListener('click', () => {
    if(!confirm('Reset will clear all locally saved ideas for this app on this device. Continue?')) return;
    localStorage.removeItem(STORAGE_KEY);
    state = structuredClone(defaultState);
    save();
    render();
    showToast('Reset');
  });

  // ---------- Init ----------
  state.timerSecondsDefault = state.timerSecondsDefault || 600;
  state.timerSecondsLeft = state.timerSecondsLeft || state.timerSecondsDefault;
  state.timerRunning = false;

  function render(){
    renderNav();
    renderHeader();
    renderPOV();
    applyVisibility();
    renderIdeaCards();
    renderTimer();

    // inputs
    sessionName.value = state.sessionName || '';
    participant.value = state.participant || '';

    sortBtn.textContent = state.sortMode === 'votes' ? 'Sort: Votes' : 'Sort: Time';
  }

  save();
  render();
  startTick();
})();
</script>
</body>
</html>
